CREATE TABLE IF NOT EXISTS collection_entity(
    id TEXT PRIMARY KEY DEFAULT (gen_random_uuid()),
    name TEXT NOT NULL
);

CREATE TABLE IF NOT EXISTS collection_users(
    collection_id TEXT NOT NULL REFERENCES collection_entity(id) ON DELETE CASCADE,
    user_id TEXT NOT NULL REFERENCES user_entity(id) ON DELETE CASCADE,
    PRIMARY KEY (collection_id, user_id)
);

insertCollection:
INSERT INTO collection_entity(name)
VALUES (:name)
RETURNING id;

insertCollectionUserRelation:
INSERT INTO collection_users(collection_id, user_id)
VALUES (:collection_id, :user_id);

selectCollectionsForUser:
SELECT c.*
FROM collection_entity AS c
JOIN collection_users AS cu
  ON cu.collection_id = c.id
WHERE cu.user_id = :user_id;

getCollectionById:
SELECT * FROM collection_entity
WHERE id = :collection_id;

getAllMembersForCollection:
SELECT user_id FROM collection_users
WHERE collection_id = :collection_id;

getCollectionsWhereUserIsOnlyMember:
SELECT c.id
FROM collection_entity AS c
LEFT JOIN collection_users AS cu
  ON cu.collection_id = c.id
GROUP BY c.id
HAVING COUNT(*) = 1 AND MAX(cu.user_id) = :user_id;

deleteCollectionById:
DELETE FROM collection_entity
WHERE id = :collection_id;

deleteCollectionsByIds:
DELETE FROM collection_entity
WHERE id IN :collection_ids;